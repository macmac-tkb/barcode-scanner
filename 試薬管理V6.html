<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Barcode Scanner (2種QR＋名前表示 CSV対応)</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
  video { width: 100%; max-width: 420px; border: 2px solid #333; border-radius: 8px; margin-bottom: 10px; }
  h2 { color: #444; }
  .row { margin: 8px 0; font-size: 1.05rem; }
  .label { color: #555; display: inline-block; min-width: 7em; text-align: right; margin-right: .5em; }
  .value { font-weight: bold; color: #0078D7; word-break: break-all; }
  .hint { font-size: .9rem; color: #666; margin-top: 8px; }
  .ok { color: #0a8a0a; }
  .warn { color: #d9534f; }
  button { margin-top: 10px; padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; }
</style>
</head>
<body>
  <h2>バーコードスキャナ（2種類のQRを順不同で読み取り）</h2>

  <video id="camera" autoplay playsinline></video>

  <div class="row">
    <span class="label">ID:</span>
    <span id="idValue" class="value">未取得</span>
  </div>
  <div class="row">
    <span class="label">試薬詳細：</span>
    <span id="detailValue" class="value">未取得</span>
  </div>

  <div id="status" class="hint">「担当者情報（nissuiid）」と「試薬情報」のQRを読み取ってください。</div>
  <button id="resetBtn" type="button">リセット</button>

  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const POWERAPPS_BASE =
      "https://apps.powerapps.com/play/e/default-5c21876a-fce9-422b-a2f6-cab1ffba2f8e/a/611dff68-2994-4792-83e9-0abd5ec0f146?tenantId=5c21876a-fce9-422b-a2f6-cab1ffba2f8e";

    // 取得状態
    let gotId = null;            // 7桁ID
    let gotName = null;          // 名前（あれば）
    let gotNissuiidFull = null;  // nissuiid のフルQR文字列
    let gotDetail = null;        // 試薬情報（加工なしでそのまま）
    let navigating = false;

    // 重複読み込み防止（同一テキストは一度だけ処理）
    const seenTexts = new Set();

    const $id = document.getElementById('idValue');
    const $detail = document.getElementById('detailValue');
    const $status = document.getElementById('status');

    function setStatus(msg, cls) {
      $status.className = 'hint ' + (cls || '');
      $status.textContent = msg;
    }

    function updateUI() {
      const displayId = gotId ? (gotName ? `${gotId} ： ${gotName}` : gotId) : '未取得';
      $id.textContent = displayId;
      $detail.textContent = gotDetail ?? '未取得';

      if (gotId && gotDetail) {
        setStatus('両方取得しました。3秒後にアプリへ遷移します。', 'ok');
      } else if (gotId) {
        setStatus('「試薬情報（tkb）」を含むQRを読み取ってください。', '');
      } else if (gotDetail) {
        setStatus('「担当者情報（nissuiid）」を含むQRを読み取ってください。', '');
      } else {
        setStatus('「担当者情報（nissuiid）」と「試薬情報（tkb）」を含むQRを読み取ってください。', '');
      }
    }

    // 表示用・判定用の軽い正規化（※元文字列は改変しない）
    function normalize(raw) {
      if (!raw) return '';
      return raw.replace(/\u3000/g, ' ')
                .replace(/[\r\n\t]+/g, ' ')
                .replace(/\s{2,}/g, ' ')
                .trim();
    }

    // 「'nissuiid,ID,メール,名前」形式をパース（先頭の'は任意）
    function parseNissuiidRecord(raw) {
      if (!raw) return null;
      const m = raw.match(/^'?\s*nissuiid\s*,\s*([^,]+)\s*,\s*([^,]+)\s*,\s*(.+)\s*$/i);
      if (!m) return null;
      return { id: m[1], email: m[2], name: m[3] };
    }

    // URL/CSV/JSON/自由テキストから key の値を抽出
    function extractValue(raw, key) {
      if (!raw) return null;
      const text = normalize(raw);

      // 1) URL/クエリ風
      try {
        const urlLike = text.includes('?') ? text : ('http://x/?' + text);
        const usp = new URL(urlLike).searchParams;
        const qp = usp.get(key);
        if (qp) return qp;
      } catch (_) {}

      // 2) key=val / key:val / key,val
      const reKV = new RegExp(`(?:^|[\\s,&;])${key}\\s*[:=,]\\s*([^\\s,&;]+)`, 'i');
      const mKV = text.match(reKV);
      if (mKV && mKV[1]) return mKV[1];

      // 3) JSON風 "key" : "val"
      const reJson = new RegExp(`["']?${key}["']?\\s*:\\s*["']([^"']+)["']`, 'i');
      const mJson = text.match(reJson);
      if (mJson && mJson[1]) return mJson[1];

      return null;
    }

    // nissuiid の抽出（「nissuiid」を含むものは必ず担当者情報として処理）
    function extractNissuiId(raw) {
      const text = normalize(raw);

      // ★最優先：文字列に "nissuiid" を含む場合は必ずIDとして扱う
      if (/nissuiid/i.test(text)) {
        // CSVの定形があれば優先パース
        const rec = parseNissuiidRecord(text);
        if (rec) return { id: rec.id, name: rec.name, full: text.replace(/^'\s*/, '').trim() };

        // それ以外は nissuiid= や JSON/CSVから拾う
        const idFromKey = extractValue(text, 'nissuiid');
        if (idFromKey) return { id: idFromKey, name: '', full: raw.trim() };

        // 最低限、文字列全体を保存（IDは未確定でも full を保持）
        return { id: '', name: '', full: raw.trim() };
      }

      // 「nissuiid」を含まないが、7桁だけの数値ならIDとみなす（補助）
      const mIDKV = text.match(/(?:^|[^\w])id\s*[:=]\s*(\d{7})(?:\D|$)/i);
      if (mIDKV) return { id: mIDKV[1], name: '', full: raw.trim() };

      const m7 = text.match(/^\d{7}$/);
      if (m7) return { id: m7[0], name: '', full: raw.trim() };

      return null;
    }

    function handle(inputRaw) {
      const raw = inputRaw;              // 元文字列（加工禁止で利用）
      const norm = normalize(inputRaw);  // 判定用

      // 同一テキストの重複処理を防止
      if (seenTexts.has(norm)) return;
      seenTexts.add(norm);

      // 1) 「nissuiid」を含むQRは必ず担当者情報として処理
      const idInfo = extractNissuiId(raw);
      if (idInfo && /nissuiid/i.test(norm)) {
        if (!gotId && idInfo.id) gotId = idInfo.id;
        if (idInfo.name) gotName = idInfo.name;
        if (!gotNissuiidFull) gotNissuiidFull = idInfo.full || raw.trim();
        updateUI();
        maybeNavigate();
        return; // ★担当者QRとして確定処理したらここで終了
      }

      // 2) まだ担当者が未取得で、かつ7桁だけ等の補助条件を満たす場合はIDとして採用
      if (!gotId && idInfo && idInfo.id) {
        gotId = idInfo.id;
        gotName = idInfo.name || gotName || '';
        gotNissuiidFull = idInfo.full || raw.trim();
        updateUI();
        maybeNavigate();
        return;
      }

      // 3) それ以外は試薬情報として「そのまま」採用（加工なし）
      if (!gotDetail) {
        gotDetail = raw.trim();
      }

      updateUI();
      maybeNavigate();
    }

    function maybeNavigate() {
      if (gotId && gotDetail && !navigating) {
        navigating = true;
        setStatus('両方取得しました。3秒後にアプリへ遷移します。', 'ok');
        setTimeout(() => {
          const url = POWERAPPS_BASE + '&' + new URLSearchParams({
            nissuiid: gotId || '',
            nissuiidFull: gotNissuiidFull || '',
            tkb: gotDetail || ''
          }).toString();
          window.location.href = url;
        }, 3000);
      }
    }

    // 連続フレームによる同一値の多重発火を軽減
    let lastText = '';
    let lastTime = 0;
    const DEDUP_MS = 1200;

    codeReader.decodeFromVideoDevice(null, 'camera', (result, err) => {
      if (result && result.text) {
        const now = Date.now();
        if (result.text === lastText && now - lastTime < DEDUP_MS) return;
        lastText = result.text;
        lastTime = now;
        handle(result.text);
      }
    }).catch(e => {
      console.error(e);
      setStatus('カメラの起動に失敗しました。ブラウザ権限とHTTPSを確認してください。', 'warn');
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      gotId = null;
      gotName = null;
      gotNissuiidFull = null;
      gotDetail = null;
      navigating = false;
      lastText = '';
      lastTime = 0;
      seenTexts.clear(); // ★重複検出をリセット
      updateUI();
      setStatus('リセットしました。読み取りを再開してください。', '');
    });

    updateUI();
  </script>
</body>
</html>
